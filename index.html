<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–£—á–µ–±–Ω—ã–π –•–∞–± 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    borderRadius: {
                        '3xl': '1.5rem',
                        '4xl': '2rem',
                        '5xl': '2.5rem',
                    }
                }
            },
            safelist: [
                'bg-blue-500', 'bg-orange-500', 'bg-purple-500', 'bg-slate-500',
                'bg-blue-600', 'bg-orange-600', 'bg-purple-600',
                'from-blue-400', 'to-blue-600', 'from-orange-400', 'to-orange-600', 'from-purple-400', 'to-purple-600',
                'bg-blue-100', 'bg-orange-100', 'bg-purple-100'
            ]
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            background-color: #f1f5f9;
            font-family: 'Inter', sans-serif;
            color: #0f172a;
            -webkit-tap-highlight-color: transparent;
            padding-top: max(1rem, env(safe-area-inset-top));
            padding-bottom: max(2rem, env(safe-area-inset-bottom));
        }

        .progress-bar-smooth {
            transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .current-day-active {
            outline: 3px solid #3b82f6;
            outline-offset: 2px;
            box-shadow: 0 25px 50px -12px rgba(59, 130, 246, 0.25);
        }

        .habit-today-marker {
            box-shadow: 0 0 0 2px #3b82f6;
        }

        .custom-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        @keyframes check-pop {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: check-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body class="px-4 md:px-8">
    <div id="app" class="max-w-6xl mx-auto">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 fade-in-up">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">–ú–æ–π 2026 –ì–æ–¥</h1>
                <div class="flex items-center gap-2 mt-2">
                    <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                    <p id="today-display" class="text-xs font-bold text-slate-500 uppercase tracking-widest"></p>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 w-full md:w-auto">
                <button id="notif-btn" onclick="requestNotifPermission()" class="hidden bg-white border border-slate-200 px-4 py-2 rounded-2xl text-[10px] font-black uppercase text-blue-600 shadow-sm hover:bg-blue-50 transition-all">
                    –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                </button>
                <div class="flex bg-white/50 p-1 rounded-2xl border border-slate-200 shadow-sm flex-grow md:flex-grow-0">
                    <button onclick="changeStudyWeek(-1)" class="p-3 hover:bg-white rounded-xl transition-all text-slate-600 active:scale-90">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                    <div class="px-4 md:px-6 flex flex-col justify-center items-center flex-grow md:min-w-[180px]">
                        <span id="week-date-range" class="text-base md:text-lg font-extrabold text-blue-600 whitespace-nowrap">...</span>
                        <span id="study-week-num" class="text-[9px] font-black uppercase text-slate-400">–ù–µ–¥–µ–ª—è –æ–±—É—á–µ–Ω–∏—è</span>
                    </div>
                    <button onclick="changeStudyWeek(1)" class="p-3 hover:bg-white rounded-xl transition-all text-slate-600 active:scale-90">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Sidebar (Habits) -->
            <aside class="lg:col-span-4 space-y-8 order-1 fade-in-up" style="animation-delay: 0.1s">
                <section class="bg-white rounded-5xl p-6 md:p-8 shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-xl font-black text-slate-900 uppercase tracking-tight">–ü—Ä–∏–≤—ã—á–∫–∏</h2>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">–¢—Ä–µ–∫–µ—Ä –¥–Ω—è</p>
                        </div>
                        <button onclick="openHabitModal()" class="bg-slate-900 text-white p-3 rounded-2xl hover:scale-105 transition-transform active:scale-95">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="3" stroke-linecap="round"></path></svg>
                        </button>
                    </div>

                    <div id="habits-list" class="space-y-10"></div>

                    <div class="mt-12 pt-8 border-t border-slate-100">
                        <div class="flex justify-between items-end mb-3">
                            <span class="text-[10px] font-black uppercase text-slate-500">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</span>
                            <span id="habit-progress-text" class="text-lg font-black text-blue-600">0%</span>
                        </div>
                        <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                            <div id="habit-progress-bar" class="bg-blue-600 h-full progress-bar-smooth shadow-sm" style="width: 0%"></div>
                        </div>
                    </div>
                </section>
            </aside>

            <!-- Main Schedule -->
            <main class="lg:col-span-8 order-2">
                <div id="schedule" class="grid grid-cols-1 gap-6"></div>
            </main>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4 z-[100] backdrop-blur-sm transition-all">
        <div class="bg-white w-full max-w-xl rounded-5xl p-6 md:p-10 custom-shadow scale-95 transition-transform flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 id="modalDayTitle" class="text-2xl md:text-3xl font-black text-slate-900">–î–µ–Ω—å</h2>
                    <p class="text-xs font-bold text-slate-400 uppercase mt-1">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</p>
                </div>
                <button onclick="closeModal()" class="text-slate-300 hover:text-slate-900 transition-colors">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5" stroke-linecap="round"></path></svg>
                </button>
            </div>

            <div id="modalTasksList" class="space-y-4 overflow-y-auto no-scrollbar mb-8 pr-1 flex-grow"></div>
            
            <div class="grid grid-cols-2 gap-4 mt-auto">
                <button onclick="addNewTaskToModal()" class="bg-slate-100 text-slate-900 font-bold py-4 rounded-3xl hover:bg-slate-200 transition-all">–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</button>
                <button onclick="saveModalChanges()" class="bg-slate-900 text-white font-bold py-4 rounded-3xl shadow-xl hover:bg-black transition-all">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
            </div>
        </div>
    </div>

    <!-- Habit Manager Modal -->
    <div id="habitModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4 z-[100] backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-5xl p-8 md:p-10 custom-shadow">
            <h2 class="text-2xl md:text-3xl font-black text-slate-900 mb-8">–ü—Ä–∏–≤—ã—á–∫–∏</h2>
            <div id="modalHabitList" class="space-y-3 mb-8 max-h-[40vh] overflow-y-auto no-scrollbar"></div>
            <div class="bg-slate-50 p-2 rounded-3xl flex gap-2 mb-6">
                <input id="newHabitInput" type="text" placeholder="–ù–æ–≤–∞—è —Ü–µ–ª—å..." class="flex-grow bg-transparent px-4 py-3 text-sm font-bold outline-none">
                <button onclick="addNewHabit()" class="bg-blue-600 text-white p-3 rounded-2xl active:scale-90 transition-transform">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="3"></path></svg>
                </button>
            </div>
            <button onclick="closeHabitModal()" class="w-full text-slate-400 font-bold py-2">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç
        const getTodayDate = () => {
            const d = new Date();
            d.setHours(0, 0, 0, 0);
            return d;
        };

        const getMondayOfCurrentWeek = () => {
            const d = getTodayDate();
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            const monday = new Date(d.setDate(diff));
            monday.setHours(0, 0, 0, 0);
            return monday;
        };

        const CALENDAR_START = getMondayOfCurrentWeek(); 
        const DAYS_SHORT = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        const MONTHS_RU = ['–Ø–Ω–≤–∞—Ä—è', '–§–µ–≤—Ä–∞–ª—è', '–ú–∞—Ä—Ç–∞', '–ê–ø—Ä–µ–ª—è', '–ú–∞—è', '–ò—é–Ω—è', '–ò—é–ª—è', '–ê–≤–≥—É—Å—Ç–∞', '–°–µ–Ω—Ç—è–±—Ä—è', '–û–∫—Ç—è–±—Ä—è', '–ù–æ—è–±—Ä—è', '–î–µ–∫–∞–±—Ä—è'];

        const defaultSchedule = [
            { day: "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", tasks: [{ id: "m1", startTime: "19:00", endTime: "21:30", subject: "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫", remindBefore: 15 }] },
            { day: "–í—Ç–æ—Ä–Ω–∏–∫", tasks: [{ id: "t1", startTime: "16:00", endTime: "17:00", subject: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", remindBefore: 15 }, { id: "t2", startTime: "18:30", endTime: "21:30", subject: "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", remindBefore: 15 }]},
            { day: "–°—Ä–µ–¥–∞", tasks: [{ id: "w1", startTime: "16:00", endTime: "18:00", subject: "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫", remindBefore: 15 }, { id: "w2", startTime: "18:30", endTime: "21:30", subject: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", remindBefore: 15 }]},
            { day: "–ß–µ—Ç–≤–µ—Ä–≥", tasks: [{ id: "th1", startTime: "19:00", endTime: "21:30", subject: "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", remindBefore: 15 }] },
            { day: "–ü—è—Ç–Ω–∏—Ü–∞", tasks: [{ id: "f1", startTime: "15:00", endTime: "17:00", subject: "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫", remindBefore: 15 }, { id: "f2", startTime: "18:30", endTime: "21:30", subject: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", remindBefore: 15 }]},
            { day: "–°—É–±–±–æ—Ç–∞", tasks: [{ id: "s1", startTime: "18:00", endTime: "20:00", subject: "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", remindBefore: 15 }] },
            { day: "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ", tasks: [{ id: "su1", startTime: "18:00", endTime: "20:00", subject: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", remindBefore: 15 }] }
        ];

        let scheduleData = JSON.parse(localStorage.getItem('study2026_schedule')) || defaultSchedule;
        let userData = JSON.parse(localStorage.getItem('study2026_userdata')) || {};
        let habitList = JSON.parse(localStorage.getItem('study2026_habits')) || [{id: 'h1', name: '–£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞'}, {id: 'h2', name: '–ß—Ç–µ–Ω–∏–µ'}];
        let notificationsSent = JSON.parse(localStorage.getItem('study2026_notif_sent')) || {};
        
        let currentWeekOffset = 0; 
        let editingDayIndex = null;

        const subjectConfig = {
            "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫": { color: "blue" },
            "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞": { color: "orange" },
            "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞": { color: "purple" },
            "default": { color: "slate" }
        };

        function calculateDuration(start, end) {
            if (!start || !end) return 0;
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            return (eh * 60 + em - (sh * 60 + sm)) / 60;
        }

        function getDateForWeek(offset, dayIdx) {
            const d = new Date(CALENDAR_START);
            d.setDate(d.getDate() + (offset * 7) + dayIdx);
            return d;
        }

        function calculateSubjectStats() {
            const stats = {};
            scheduleData.forEach((day) => {
                day.tasks.forEach(t => {
                    const dur = calculateDuration(t.startTime, t.endTime);
                    if (!stats[t.subject]) stats[t.subject] = { total: 0, done: 0 };
                    stats[t.subject].total += dur;
                    if (userData[`task_w${currentWeekOffset}_${t.id}`]) stats[t.subject].done += dur;
                });
            });
            return stats;
        }

        function init() {
            updateLiveDisplay();
            renderAll();
            checkNotifSupport();
            startNotificationEngine();
            setupMidnightRefresh();
        }

        function updateLiveDisplay() {
            const today = new Date();
            document.getElementById('today-display').textContent = today.toLocaleDateString('ru-RU', { 
                day: 'numeric', month: 'long', year: 'numeric'
            });
        }

        function setupMidnightRefresh() {
            const now = new Date();
            const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            setTimeout(() => window.location.reload(), tomorrow - now);
        }

        // --- –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ---
        function checkNotifSupport() {
            if ("Notification" in window) {
                if (Notification.permission !== "granted") {
                    document.getElementById('notif-btn').classList.remove('hidden');
                }
            }
        }

        function requestNotifPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    document.getElementById('notif-btn').classList.add('hidden');
                    new Notification("–£—á–µ–±–Ω—ã–π –•–∞–±", { body: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω—ã!" });
                }
            });
        }

        function startNotificationEngine() {
            setInterval(() => {
                const now = new Date();
                const dayIdx = (now.getDay() + 6) % 7; // –ü–Ω=0
                const todayStr = now.toISOString().split('T')[0];
                const currentTimeMin = now.getHours() * 60 + now.getMinutes();

                scheduleData[dayIdx].tasks.forEach(task => {
                    if (!task.remindBefore || task.remindBefore <= 0) return;
                    
                    const [h, m] = task.startTime.split(':').map(Number);
                    const taskTimeMin = h * 60 + m;
                    const triggerTime = taskTimeMin - task.remindBefore;

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º, –µ—Å–ª–∏ –≤—Ä–µ–º—è —Å–æ–≤–ø–∞–ª–æ –∏ —Å–µ–≥–æ–¥–Ω—è –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–∫–∞
                    const notifId = `${todayStr}_${task.id}`;
                    if (currentTimeMin === triggerTime && !notificationsSent[notifId]) {
                        if (Notification.permission === "granted") {
                            new Notification(`–£—Ä–æ–∫ —Å–∫–æ—Ä–æ –Ω–∞—á–Ω–µ—Ç—Å—è!`, {
                                body: `${task.subject} –Ω–∞—á–Ω–µ—Ç—Å—è —á–µ—Ä–µ–∑ ${task.remindBefore} –º–∏–Ω. (${task.startTime})`,
                                icon: 'https://cdn-icons-png.flaticon.com/512/3602/3602123.png'
                            });
                            notificationsSent[notifId] = true;
                            localStorage.setItem('study2026_notif_sent', JSON.stringify(notificationsSent));
                        }
                    }
                });
            }, 60000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        }

        // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ ---
        function renderAll() {
            updateWeekRange();
            renderHabits();
            renderSchedule();
        }

        function updateWeekRange() {
            const start = getDateForWeek(currentWeekOffset, 0);
            const end = getDateForWeek(currentWeekOffset, 6);
            let rangeText = `${start.getDate()} ‚Äî ${end.getDate()} ${MONTHS_RU[end.getMonth()]}`;
            document.getElementById('week-date-range').textContent = rangeText;
            document.getElementById('study-week-num').textContent = currentWeekOffset === 0 ? "–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è" : (currentWeekOffset > 0 ? `–ß–µ—Ä–µ–∑ ${currentWeekOffset} –Ω–µ–¥.` : `${Math.abs(currentWeekOffset)} –Ω–µ–¥. –Ω–∞–∑–∞–¥`);
        }

        function renderHabits() {
            const container = document.getElementById('habits-list');
            container.innerHTML = '';
            let doneTotal = 0;
            const todayStr = new Date().toISOString().split('T')[0];

            habitList.forEach(habit => {
                let dots = '';
                for (let i = 0; i < 7; i++) {
                    const d = getDateForWeek(currentWeekOffset, i);
                    const dk = d.toISOString().split('T')[0];
                    const isDone = userData[`hbt_${dk}_${habit.id}`];
                    const isToday = (dk === todayStr);

                    if (isDone) doneTotal++;

                    dots += `
                        <div class="flex flex-col items-center gap-1.5">
                            <span class="text-[8px] font-black ${isToday ? 'text-blue-600' : 'text-slate-300'} uppercase">${DAYS_SHORT[i]}</span>
                            <button onclick="toggleHabit('${dk}', '${habit.id}')" 
                                    class="w-8 h-8 md:w-10 md:h-10 rounded-xl border-2 transition-all flex items-center justify-center active:scale-90
                                    ${isDone ? 'bg-blue-600 border-blue-600 shadow-lg animate-pop' : 'border-slate-100 bg-slate-50'}
                                    ${isToday ? 'habit-today-marker' : ''}">
                                ${isDone ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path d="M5 13l4 4L19 7"></path></svg>' : ''}
                            </button>
                            <span class="text-[9px] font-bold ${isToday ? 'text-blue-600 font-black' : 'text-slate-400'}">${d.getDate()}</span>
                        </div>
                    `;
                }
                const div = document.createElement('div');
                div.innerHTML = `<p class="text-[10px] font-black uppercase text-slate-800 mb-4 px-1">${habit.name}</p><div class="flex justify-between items-center">${dots}</div>`;
                container.appendChild(div);
            });

            const pct = (habitList.length * 7) > 0 ? Math.round((doneTotal / (habitList.length * 7)) * 100) : 0;
            document.getElementById('habit-progress-text').textContent = `${pct}%`;
            document.getElementById('habit-progress-bar').style.width = `${pct}%`;
        }

        function renderSchedule() {
            const container = document.getElementById('schedule');
            container.innerHTML = '';
            const subStats = calculateSubjectStats();
            const todayStr = getTodayDate().toISOString().split('T')[0];

            scheduleData.forEach((day, idx) => {
                const dateObj = getDateForWeek(currentWeekOffset, idx);
                const dk = dateObj.toISOString().split('T')[0];
                const isToday = dk === todayStr;
                
                let tasksHtml = '';
                day.tasks.forEach(t => {
                    const isD = userData[`task_w${currentWeekOffset}_${t.id}`];
                    const cfg = subjectConfig[t.subject] || subjectConfig.default;
                    const duration = calculateDuration(t.startTime, t.endTime);
                    const sData = subStats[t.subject] || {done:0, total:1};
                    const subPct = Math.min((sData.done / sData.total) * 100, 100);

                    tasksHtml += `
                        <div onclick="toggleTask('${t.id}')" class="group relative flex flex-col p-5 md:p-6 cursor-pointer transition-all hover:bg-slate-50/80 active:bg-slate-100">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 md:w-12 md:h-12 rounded-xl border-2 mr-4 flex items-center justify-center flex-shrink-0
                                    ${isD ? `bg-${cfg.color}-500 border-${cfg.color}-500 shadow-lg animate-pop` : 'border-slate-200'}">
                                    ${isD ? '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M5 13l4 4L19 7"></path></svg>' : ''}
                                </div>
                                <div class="flex-grow flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-sm text-slate-900 ${isD ? 'line-through opacity-30 text-slate-400' : ''}">${t.subject}</div>
                                        <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest mt-1">
                                            ${t.startTime} ‚Äî ${t.endTime} <span class="ml-1 opacity-60">| ${duration.toFixed(1)}—á</span>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end gap-1">
                                        <div class="bg-${cfg.color}-50 text-${cfg.color}-600 text-[8px] font-black px-2 py-1 rounded-lg uppercase">–£—Ä–æ–∫</div>
                                        ${t.remindBefore > 0 ? `<div class="text-[7px] text-slate-400 font-bold uppercase tracking-tighter">üîî ${t.remindBefore}–º</div>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="pl-[56px] md:pl-[68px]">
                                <div class="flex justify-between items-center mb-1.5">
                                     <span class="text-[9px] font-black text-${cfg.color}-500 uppercase tracking-widest">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–µ–¥–º–µ—Ç–∞</span>
                                     <span class="text-[9px] font-black text-${cfg.color}-600 uppercase tracking-widest">${Math.round(subPct)}%</span>
                                </div>
                                <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                    <div class="h-full bg-${cfg.color}-500 progress-bar-smooth" style="width: ${subPct}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                const dayCard = document.createElement('div');
                dayCard.className = `bg-white rounded-5xl border overflow-hidden transition-all fade-in-up ${isToday ? 'current-day-active' : 'border-slate-100 shadow-sm'}`;
                dayCard.style.animationDelay = `${idx * 0.05}s`;
                dayCard.innerHTML = `
                    <div class="px-6 py-4 flex justify-between items-center border-b border-slate-50 ${isToday ? 'bg-blue-50/40' : 'bg-white'}">
                        <div class="flex gap-4 items-center">
                            <div class="w-10 h-10 rounded-xl ${isToday ? 'bg-blue-600' : 'bg-slate-900'} flex flex-col items-center justify-center text-white">
                                <span class="text-[8px] font-black uppercase ${isToday ? 'text-blue-200' : 'text-slate-400'}">${DAYS_SHORT[idx]}</span>
                                <span class="text-base font-extrabold leading-none">${dateObj.getDate()}</span>
                            </div>
                            <span class="text-xs font-black text-slate-900 uppercase tracking-tight">${day.day}</span>
                        </div>
                        <button onclick="event.stopPropagation(); openEditModal(${idx})" class="w-9 h-9 rounded-xl bg-slate-50 text-slate-400 hover:bg-slate-900 hover:text-white transition-all flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2"></path></svg>
                        </button>
                    </div>
                    <div class="divide-y divide-slate-50">${tasksHtml || '<p class="p-10 text-center text-slate-300 text-[10px] font-black uppercase tracking-widest">–ü–ª–∞–Ω –ø—É—Å—Ç</p>'}</div>
                `;
                container.appendChild(dayCard);
            });
        }

        function toggleTask(id) {
            const key = `task_w${currentWeekOffset}_${id}`;
            userData[key] = !userData[key];
            save(); renderAll();
        }

        function toggleHabit(dateKey, id) {
            const key = `hbt_${dateKey}_${id}`;
            userData[key] = !userData[key];
            save(); renderHabits();
        }

        function save() { 
            localStorage.setItem('study2026_userdata', JSON.stringify(userData)); 
        }

        function changeStudyWeek(d) {
            currentWeekOffset += d;
            renderAll();
        }

        function openEditModal(i) {
            editingDayIndex = i;
            document.getElementById('modalDayTitle').textContent = scheduleData[i].day;
            document.getElementById('editModal').style.display = 'flex';
            renderModalTasks();
        }

        function closeModal() { 
            document.getElementById('editModal').style.display = 'none';
        }

        function renderModalTasks() {
            const list = document.getElementById('modalTasksList');
            list.innerHTML = '';
            scheduleData[editingDayIndex].tasks.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = 'bg-slate-50 p-6 rounded-4xl space-y-4 border border-slate-100 mb-4';
                div.innerHTML = `
                    <div class="flex gap-2">
                        <select class="flex-grow bg-white rounded-2xl p-4 text-sm font-bold border border-slate-200 outline-none" onchange="scheduleData[${editingDayIndex}].tasks[${i}].subject=this.value">
                            <option value="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" ${t.subject === '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞' ? 'selected' : ''}>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
                            <option value="–†—É—Å—Å–∫–∏–π —è–∑—ã–∫" ${t.subject === '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫' ? 'selected' : ''}>–†—É—Å—Å–∫–∏–π —è–∑—ã–∫</option>
                            <option value="–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞" ${t.subject === '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞' ? 'selected' : ''}>–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</option>
                        </select>
                        <button onclick="scheduleData[${editingDayIndex}].tasks.splice(${i},1);renderModalTasks()" class="bg-white text-red-500 w-14 h-14 rounded-2xl flex items-center justify-center border border-slate-200">√ó</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-white rounded-2xl p-3 border border-slate-200">
                            <label class="block text-[8px] font-black text-slate-400 uppercase mb-1">–ù–∞—á–∞–ª–æ</label>
                            <input type="time" value="${t.startTime}" class="w-full text-sm font-bold outline-none" onchange="scheduleData[${editingDayIndex}].tasks[${i}].startTime=this.value">
                        </div>
                        <div class="bg-white rounded-2xl p-3 border border-slate-200">
                            <label class="block text-[8px] font-black text-slate-400 uppercase mb-1">–ö–æ–Ω–µ—Ü</label>
                            <input type="time" value="${t.endTime}" class="w-full text-sm font-bold outline-none" onchange="scheduleData[${editingDayIndex}].tasks[${i}].endTime=this.value">
                        </div>
                    </div>
                    <div class="bg-blue-50/50 rounded-2xl p-3 border border-blue-100">
                        <label class="block text-[8px] font-black text-blue-600 uppercase mb-1">–ù–∞–ø–æ–º–Ω–∏—Ç—å –∑–∞ (–º–∏–Ω)</label>
                        <input type="number" value="${t.remindBefore || 0}" placeholder="0 - –≤—ã–∫–ª" class="bg-transparent w-full text-sm font-bold outline-none" onchange="scheduleData[${editingDayIndex}].tasks[${i}].remindBefore=parseInt(this.value)||0">
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function addNewTaskToModal() {
            scheduleData[editingDayIndex].tasks.push({ id: 't'+Date.now(), startTime: '18:00', endTime: '20:00', subject: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', remindBefore: 15 });
            renderModalTasks();
        }

        function saveModalChanges() {
            localStorage.setItem('study2026_schedule', JSON.stringify(scheduleData));
            closeModal(); renderAll();
        }

        function openHabitModal() { document.getElementById('habitModal').style.display = 'flex'; renderHabitManager(); }
        function closeHabitModal() { document.getElementById('habitModal').style.display = 'none'; }

        function renderHabitManager() {
            const list = document.getElementById('modalHabitList');
            list.innerHTML = '';
            habitList.forEach((h, i) => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-slate-50 p-4 rounded-2xl border border-slate-100";
                div.innerHTML = `<span class="font-bold text-slate-800 text-sm">${h.name}</span><button onclick=\"habitList.splice(${i},1);renderHabitManager();renderHabits()\" class="text-red-400 font-bold p-2 px-3 bg-white rounded-lg text-xs">–£–¥–∞–ª–∏—Ç—å</button>`;
                list.appendChild(div);
            });
            localStorage.setItem('study2026_habits', JSON.stringify(habitList));
        }

        function addNewHabit() {
            const input = document.getElementById('newHabitInput');
            if (input.value) {
                habitList.push({ id: 'h'+Date.now(), name: input.value });
                input.value = '';
                renderHabitManager(); renderHabits();
            }
        }

        window.onload = init;
    </script>
</body>
</html>
