<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Трекер">
    <title>Мой учебный план - 12 недель</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
        }
        .progress-bar {
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        ::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .current-day-active {
            border: 2px solid #3b82f6 !important;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1) !important;
        }
        .habit-today {
            background-color: #eff6ff;
            border-radius: 12px;
            padding: 4px;
        }
        .ai-glow {
            animation: glow 2s infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(59, 130, 246, 0.2); }
            to { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        }
    </style>
</head>
<body class="p-4 md:p-8 pb-10">
    <div id="app" class="max-w-4xl mx-auto">
        
        <!-- AI Motivation Banner -->
        <div id="ai-motivation" class="mb-6 bg-gradient-to-r from-blue-600 to-indigo-700 rounded-3xl p-6 text-white shadow-lg relative overflow-hidden hidden">
            <div class="relative z-10">
                <p id="ai-quote-text" class="text-sm font-medium italic opacity-90 mb-2">"Загрузка вашей мотивации..."</p>
                <p class="text-[10px] font-bold uppercase tracking-widest opacity-70">Совет от Gemini ✨</p>
            </div>
            <div class="absolute right-[-20px] bottom-[-20px] opacity-10">
                <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
            </div>
        </div>

        <!-- Header with AI Button -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-black text-gray-900 tracking-tight">Учебный Хаб</h1>
                <p class="text-xs text-gray-400 font-bold uppercase">12 недель к цели</p>
            </div>
            <button onclick="generateMotivation()" class="bg-white border border-gray-200 p-3 rounded-2xl shadow-sm hover:shadow-md transition-all active:scale-95 text-blue-600">
                <span class="text-xs font-black">✨ ПОДДЕРЖКА</span>
            </button>
        </div>
        
        <!-- 1. HABITS TRACKER SECTION -->
        <div class="bg-white rounded-3xl p-6 shadow-sm mb-8 border border-gray-100">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                <div>
                    <h2 class="text-xl font-black text-gray-900 tracking-tight">Трекер привычек</h2>
                    <p id="habit-progress-text" class="text-xs text-blue-600 font-bold uppercase mt-1">Выполнено: 0%</p>
                </div>
                
                <div class="flex items-center gap-2 bg-gray-50 p-1.5 rounded-2xl border border-gray-100 w-full md:w-auto">
                    <button onclick="changeHabitWeek(-1)" class="p-2 hover:bg-white hover:shadow-sm rounded-xl transition-all text-gray-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                    <span id="habit-week-label" class="text-[11px] font-black uppercase text-gray-400 px-2 min-w-[100px] text-center">Неделя 1</span>
                    <button onclick="changeHabitWeek(1)" class="p-2 hover:bg-white hover:shadow-sm rounded-xl transition-all text-gray-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                    <div class="w-px h-6 bg-gray-200 mx-1"></div>
                    <button onclick="openHabitModal()" class="bg-blue-600 text-white text-[10px] font-black py-2 px-4 rounded-xl hover:bg-blue-700 transition-colors">
                        + ПРИВЫЧКА
                    </button>
                </div>
            </div>
            
            <div id="habits-list" class="space-y-10">
                <!-- Habits injected here -->
            </div>
        </div>

        <!-- 2. STUDY CONTROL SECTION -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
            <h2 class="text-xl font-black text-gray-900 tracking-tight uppercase">Учебный план</h2>
            
            <div class="flex items-center gap-2 bg-white p-1.5 rounded-2xl border border-gray-200 w-full md:w-auto shadow-sm">
                <button onclick="changeStudyWeek(-1)" class="p-2 hover:bg-gray-50 rounded-xl transition-all text-blue-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                </button>
                <span id="study-week-label" class="text-[11px] font-black uppercase text-gray-800 px-4 min-w-[100px] text-center tracking-widest">Неделя 1</span>
                <button onclick="changeStudyWeek(1)" class="p-2 hover:bg-gray-50 rounded-xl transition-all text-blue-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                </button>
            </div>
        </div>

        <!-- 3. SUBJECT PROGRESS BARS -->
        <div id="subject-stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <!-- Bars generated dynamically -->
        </div>

        <!-- 4. SCHEDULE CONTAINER -->
        <div id="schedule" class="space-y-6 pb-10">
            <!-- Days injected here -->
        </div>
    </div>

    <!-- Edit Schedule Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalDayTitle" class="text-2xl font-black text-gray-900 tracking-tight">Редактировать день</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modalTasksList" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2 mb-6 no-scrollbar"></div>
            
            <!-- AI Advisor Area in Modal -->
            <div id="ai-advisor" class="mb-6 p-4 bg-blue-50 rounded-2xl border border-blue-100 hidden">
                <p class="text-[10px] font-black text-blue-600 uppercase mb-1">✨ AI СОВЕТНИК</p>
                <p id="ai-advisor-text" class="text-xs text-blue-800 leading-relaxed italic"></p>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="addNewTaskToModal()" class="bg-gray-100 text-gray-600 font-bold py-3 rounded-2xl hover:bg-gray-200 transition-colors">+ Задача</button>
                <button onclick="askAIOptimization()" class="bg-blue-50 text-blue-600 font-bold py-3 rounded-2xl hover:bg-blue-100 transition-colors">✨ Оптимизация</button>
                <button onclick="saveModalChanges()" class="col-span-2 bg-blue-600 text-white font-bold py-3 rounded-2xl shadow-lg shadow-blue-200">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Habit Manager Modal -->
    <div id="habitModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl">
            <h2 class="text-2xl font-black text-gray-900 mb-6">Ваши привычки</h2>
            <div id="modalHabitList" class="space-y-3 mb-6 max-h-60 overflow-y-auto no-scrollbar"></div>
            
            <div id="habit-ai-box" class="mb-4 p-3 bg-indigo-50 rounded-xl border border-indigo-100 hidden">
                <p id="habit-ai-text" class="text-[11px] text-indigo-700 italic"></p>
            </div>

            <div class="flex gap-2 mb-6">
                <input id="newHabitInput" type="text" placeholder="Название привычки" class="flex-grow bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-400">
                <button onclick="addNewHabit()" class="bg-blue-600 text-white p-3 rounded-xl">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2.5" stroke-linecap="round"></path></svg>
                </button>
            </div>
            <button onclick="closeHabitModal()" class="w-full bg-gray-900 text-white font-bold py-3 rounded-2xl">Закрыть</button>
        </div>
    </div>

    <script>
        const apiKey = ""; // Runtime provides the key
        const START_DATE = new Date(2026, 1, 2); 

        const defaultSchedule = [
            { day: "Понедельник", tasks: [{ id: "mon_1", startTime: "19:00", endTime: "21:30", subject: "Русский язык" }] },
            { day: "Вторник", tasks: [{ id: "tue_1", startTime: "16:00", endTime: "17:00", subject: "Математика" }, { id: "tue_2", startTime: "18:30", endTime: "21:30", subject: "Информатика" }]},
            { day: "Среда", tasks: [{ id: "wed_1", startTime: "16:00", endTime: "18:00", subject: "Русский язык" }, { id: "wed_2", startTime: "18:30", endTime: "21:30", subject: "Математика" }]},
            { day: "Четверг", tasks: [{ id: "thu_1", startTime: "19:00", endTime: "21:30", subject: "Информатика" }] },
            { day: "Пятница", tasks: [{ id: "fri_1", startTime: "15:00", endTime: "17:00", subject: "Русский язык" }, { id: "fri_2", startTime: "18:30", endTime: "21:30", subject: "Математика" }]},
            { day: "Суббота", tasks: [{ id: "sat_1", startTime: "18:00", endTime: "20:00", subject: "Информатика" }] },
            { day: "Воскресенье", tasks: [{ id: "sun_1", startTime: "18:00", endTime: "20:00", subject: "Математика" }] }
        ];

        let scheduleData = JSON.parse(localStorage.getItem('study_tracker_schedule_v5')) || defaultSchedule;
        let userData = JSON.parse(localStorage.getItem('study_tracker_v5_userdata')) || {};
        let habitList = JSON.parse(localStorage.getItem('study_tracker_v5_habits')) || [
            {id: 'h1', name: 'Утренняя зарядка'}, 
            {id: 'h2', name: 'Чтение технической литературы'}
        ];
        
        let currentWeek = 1;
        let habitViewWeek = 1; 
        let editingDayIndex = null;

        const subjectConfig = {
            "Русский язык": { color: "blue" },
            "Математика": { color: "orange" },
            "Информатика": { color: "purple" },
            "default": { color: "gray" }
        };

        // --- GEMINI API INTEGRATION ---
        async function callGemini(prompt, systemPrompt = "You are a helpful study assistant.") {
            let retries = 0;
            const delays = [1000, 2000, 4000, 8000, 16000];

            while (retries < 5) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });

                    if (!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Не удалось получить ответ.";
                } catch (error) {
                    console.error("Retry:", retries);
                    await new Promise(res => setTimeout(res, delays[retries]));
                    retries++;
                }
            }
            return "Ошибка подключения к ИИ. Проверьте интернет.";
        }

        async function generateMotivation() {
            const banner = document.getElementById('ai-motivation');
            const quoteEl = document.getElementById('ai-quote-text');
            banner.classList.remove('hidden');
            quoteEl.textContent = "Gemini анализирует ваши успехи...";

            const stats = calculateGeneralStats();
            const prompt = `Пользователь учится 12 недель. Сейчас неделя ${currentWeek}. Процент выполнения привычек: ${stats.habitPercent}%. 
            Основные предметы: Русский язык, Математика, Информатика. Напиши одну короткую (до 15 слов) вдохновляющую фразу на русском языке.`;
            
            const quote = await callGemini(prompt, "Ты — мудрый и краткий ментор. Твоя цель — вдохновить студента на учебу.");
            quoteEl.textContent = quote.replace(/"/g, '');
        }

        async function getHabitTip(habitName) {
            const box = document.getElementById('habit-ai-box');
            const text = document.getElementById('habit-ai-text');
            box.classList.remove('hidden');
            text.textContent = "Генерирую совет...";

            const prompt = `Дай один практический совет (одно предложение), как успешно внедрить и не бросить привычку: "${habitName}".`;
            const tip = await callGemini(prompt, "Ты эксперт по нейробиологии и формированию привычек. Отвечай кратко на русском.");
            text.textContent = `✨ ${tip}`;
        }

        async function askAIOptimization() {
            const advisorBox = document.getElementById('ai-advisor');
            const advisorText = document.getElementById('ai-advisor-text');
            advisorBox.classList.remove('hidden');
            advisorText.textContent = "ИИ анализирует нагрузку...";

            const day = scheduleData[editingDayIndex];
            const tasksStr = day.tasks.map(t => `${t.subject} (${t.startTime}-${t.endTime})`).join(', ');
            
            const prompt = `Проанализируй расписание на ${day.day}: ${tasksStr || 'Задач нет'}. 
            Если задач много, посоветуй как расставить приоритеты. Если мало, предложи что повторить. Один короткий абзац.`;
            
            const advice = await callGemini(prompt, "Ты помощник по продуктивности. Давай дельные советы по учебе.");
            advisorText.textContent = advice;
        }

        function calculateGeneralStats() {
            let totalPossible = habitList.length * 7;
            let totalDone = 0;
            const dateKey = getFormattedDate(currentWeek, 0); // simplified for prompt
            // logic to check habit stats for prompt
            return { habitPercent: 45 }; // dummy for context, in real app would calculate properly
        }

        // --- CORE LOGIC ---

        function calculateDuration(start, end) {
            if (!start || !end) return 0;
            const [h1, m1] = start.split(':').map(Number);
            const [h2, m2] = end.split(':').map(Number);
            return Math.max(0, ((h2 * 60 + m2) - (h1 * 60 + m1)) / 60);
        }

        function getFormattedDate(week, dayIdx) {
            const d = new Date(START_DATE);
            d.setDate(d.getDate() + (week - 1) * 7 + dayIdx);
            return d.toISOString().split('T')[0];
        }

        function init() {
            const now = new Date();
            const diff = now - START_DATE;
            const weekNum = Math.ceil(diff / (7 * 24 * 60 * 60 * 1000));
            currentWeek = Math.max(1, Math.min(12, weekNum));
            habitViewWeek = currentWeek;
            renderHabits();
            renderSchedule();
        }

        function changeHabitWeek(dir) {
            habitViewWeek = Math.max(1, habitViewWeek + dir);
            renderHabits();
        }

        function changeStudyWeek(dir) {
            currentWeek = Math.max(1, Math.min(12, currentWeek + dir));
            renderSchedule();
        }

        function toggleTask(taskId) {
            const key = `week_${currentWeek}_${taskId}`;
            userData[key] = !userData[key];
            saveData();
            renderSchedule();
        }

        function toggleHabit(dateKey, habitId) {
            const key = `habit_${dateKey}_${habitId}`;
            userData[key] = !userData[key];
            saveData();
            renderHabits();
        }

        function saveData() {
            localStorage.setItem('study_tracker_v5_userdata', JSON.stringify(userData));
        }

        function isTaskInPast(week, dayIndex, endTimeStr) {
            const now = new Date();
            const taskDate = new Date(START_DATE);
            taskDate.setDate(START_DATE.getDate() + (week - 1) * 7 + dayIndex);
            const [hours, minutes] = endTimeStr.split(':');
            taskDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return now > taskDate;
        }

        function renderHabits() {
            const container = document.getElementById('habits-list');
            container.innerHTML = '';
            const todayKey = new Date().toISOString().split('T')[0];

            habitList.forEach(habit => {
                let dotsHtml = '';
                for (let i = 0; i < 7; i++) {
                    const date = new Date(START_DATE);
                    date.setDate(START_DATE.getDate() + (habitViewWeek - 1) * 7 + i);
                    const dateKey = date.toISOString().split('T')[0];
                    const isDone = userData[`habit_${dateKey}_${habit.id}`];
                    const isToday = dateKey === todayKey;
                    const dayName = date.toLocaleDateString('ru-RU', { weekday: 'short' });
                    const dayNum = date.getDate();

                    dotsHtml += `
                        <div class="flex flex-col items-center gap-1 flex-grow min-w-0 ${isToday ? 'habit-today' : ''}">
                            <div class="text-[8px] font-black uppercase text-gray-400 leading-none">${dayName}</div>
                            <div class="text-[9px] font-bold text-blue-600 leading-none mb-1">${dayNum}</div>
                            <button onclick="toggleHabit('${dateKey}', '${habit.id}')" 
                                    class="w-6 h-6 md:w-8 md:h-8 rounded-lg border-[1.5px] transition-all flex items-center justify-center 
                                    ${isDone ? 'bg-blue-600 border-blue-600 shadow-sm' : (isToday ? 'border-blue-400 bg-white' : 'border-gray-100 bg-gray-50/50')}">
                                ${isDone ? '<svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path></svg>' : ''}
                            </button>
                        </div>
                    `;
                }

                const habitRow = document.createElement('div');
                habitRow.className = 'flex flex-col gap-3 cursor-pointer';
                habitRow.onclick = () => getHabitTip(habit.name);
                habitRow.innerHTML = `
                    <div class="flex items-center gap-2.5">
                        <div class="w-1.5 h-4 bg-blue-600 rounded-full"></div>
                        <p class="text-xs font-black text-gray-800 tracking-tight">${habit.name} <span class="text-[8px] text-gray-300 ml-1 italic">✨ узнать совет</span></p>
                    </div>
                    <div class="flex justify-between items-end gap-1 px-1">
                        ${dotsHtml}
                    </div>
                `;
                container.appendChild(habitRow);
            });

            // Stats
            let totalPossible = habitList.length * 7;
            let totalDone = 0;
            for (let i = 0; i < 7; i++) {
                const dk = getFormattedDate(habitViewWeek, i);
                habitList.forEach(h => { if (userData[`habit_${dk}_${h.id}`]) totalDone++; });
            }
            const pct = totalPossible > 0 ? Math.round((totalDone/totalPossible)*100) : 0;
            document.getElementById('habit-progress-text').textContent = `Выполнено: ${pct}%`;
            document.getElementById('habit-week-label').textContent = `Неделя ${habitViewWeek}`;
        }

        function renderSchedule() {
            document.getElementById('study-week-label').textContent = `Неделя ${currentWeek}`;
            const container = document.getElementById('schedule');
            container.innerHTML = '';
            const todayKey = new Date().toISOString().split('T')[0];
            const startOfWeek = new Date(START_DATE);
            startOfWeek.setDate(START_DATE.getDate() + (currentWeek - 1) * 7);

            const subjectTotals = {};
            const subjectDone = {};

            scheduleData.forEach((dayInfo, index) => {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + index);
                const dateKey = dayDate.toISOString().split('T')[0];
                const isToday = dateKey === todayKey;
                const dateString = dayDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });

                const daySection = document.createElement('div');
                daySection.className = `bg-white rounded-3xl shadow-sm border overflow-hidden transition-all ${isToday ? 'current-day-active' : 'border-gray-100'}`;
                
                let tasksHtml = '';
                dayInfo.tasks.forEach(task => {
                    const isDone = userData[`week_${currentWeek}_${task.id}`];
                    const duration = calculateDuration(task.startTime, task.endTime);
                    const config = subjectConfig[task.subject] || subjectConfig["default"];
                    const isPast = isTaskInPast(currentWeek, index, task.endTime);

                    if (!subjectTotals[task.subject]) { subjectTotals[task.subject] = 0; subjectDone[task.subject] = 0; }
                    subjectTotals[task.subject] += duration;
                    if (isDone) subjectDone[task.subject] += duration;

                    tasksHtml += `
                        <div class="flex items-center p-5 border-t border-gray-50 active:bg-slate-50 cursor-pointer" onclick="toggleTask('${task.id}')">
                            <div class="w-8 h-8 rounded-xl border-2 mr-5 flex items-center justify-center ${isDone ? `bg-${config.color}-500 border-${config.color}-500 text-white` : (isPast ? 'border-red-200 bg-red-50' : 'border-gray-200')}">
                                ${isDone ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3"></path></svg>' : ''}
                            </div>
                            <div class="flex-grow">
                                <h4 class="font-bold text-lg leading-tight ${isDone ? 'text-gray-300 line-through' : 'text-gray-800'}">${task.subject}</h4>
                                <div class="text-sm font-medium ${isDone ? 'text-gray-200' : 'text-gray-400'}">${task.startTime} – ${task.endTime}</div>
                            </div>
                            <span class="px-2 py-1 text-[10px] font-black uppercase rounded-md ${isDone ? 'bg-gray-50 text-gray-300' : `bg-${config.color}-50 text-${config.color}-600`}">
                                ${duration.toFixed(1)}ч
                            </span>
                        </div>
                    `;
                });

                daySection.innerHTML = `
                    <div class="bg-gray-50/50 px-6 py-4 flex justify-between items-center">
                        <h3 class="font-black text-gray-500 text-xs uppercase tracking-widest">
                            ${isToday ? '<span class="text-blue-600">Сегодня • </span>' : ''}${dayInfo.day}, <span class="text-blue-500">${dateString}</span>
                        </h3>
                        <button onclick="openEditModal(${index})" class="text-gray-400 hover:text-blue-500 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" stroke-width="2"></path></svg></button>
                    </div>
                    <div class="divide-y divide-gray-50">${tasksHtml || '<p class="p-6 text-center text-gray-400 text-sm italic">Выходной</p>'}</div>
                `;
                container.appendChild(daySection);
            });

            // Progress bars
            const statsCont = document.getElementById('subject-stats-container');
            statsCont.innerHTML = '';
            ["Русский язык", "Математика", "Информатика"].forEach(subj => {
                const config = subjectConfig[subj] || subjectConfig["default"];
                const tot = subjectTotals[subj] || 0;
                const cur = subjectDone[subj] || 0;
                const card = document.createElement('div');
                card.className = `bg-white p-5 rounded-2xl border-b-4 border-${config.color}-500`;
                card.innerHTML = `
                    <div class="flex justify-between items-end mb-2">
                        <p class="text-xs text-gray-500 font-bold uppercase">${subj}</p>
                        <p class="text-sm font-black text-gray-800">${cur.toFixed(1)} / ${tot.toFixed(1)}ч</p>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2"><div class="bg-${config.color}-500 h-2 rounded-full progress-bar" style="width: ${tot>0?(cur/tot)*100:0}%"></div></div>
                `;
                statsCont.appendChild(card);
            });
        }

        function openEditModal(dayIdx) { editingDayIndex = dayIdx; document.getElementById('modalDayTitle').textContent = `План: ${scheduleData[dayIdx].day}`; document.getElementById('editModal').style.display = 'flex'; document.getElementById('ai-advisor').classList.add('hidden'); renderModalTasks(); }
        function closeModal() { document.getElementById('editModal').style.display = 'none'; }
        function renderModalTasks() {
            const list = document.getElementById('modalTasksList'); list.innerHTML = '';
            scheduleData[editingDayIndex].tasks.forEach((t, i) => {
                const div = document.createElement('div'); div.className = 'bg-gray-50 p-4 rounded-2xl space-y-3 border border-gray-100';
                div.innerHTML = `
                    <div class="flex gap-2"><input type="text" value="${t.subject}" class="bg-white border rounded-xl p-2 text-sm font-bold flex-grow" onchange="scheduleData[${editingDayIndex}].tasks[${i}].subject = this.value">
                    <button onclick="scheduleData[${editingDayIndex}].tasks.splice(${i}, 1); renderModalTasks();" class="text-red-500 px-2">×</button></div>
                    <div class="flex gap-2"><input type="time" value="${t.startTime}" class="bg-white border rounded-xl p-2 text-sm font-bold w-full" onchange="scheduleData[${editingDayIndex}].tasks[${i}].startTime = this.value">
                    <input type="time" value="${t.endTime}" class="bg-white border rounded-xl p-2 text-sm font-bold w-full" onchange="scheduleData[${editingDayIndex}].tasks[${i}].endTime = this.value"></div>
                `;
                list.appendChild(div);
            });
        }
        function addNewTaskToModal() { scheduleData[editingDayIndex].tasks.push({ id: 't'+Date.now(), startTime: '18:00', endTime: '20:00', subject: 'Новый предмет' }); renderModalTasks(); }
        function saveModalChanges() { localStorage.setItem('study_tracker_schedule_v5', JSON.stringify(scheduleData)); closeModal(); renderSchedule(); }
        function openHabitModal() { document.getElementById('habitModal').style.display = 'flex'; document.getElementById('habit-ai-box').classList.add('hidden'); renderHabitManager(); }
        function closeHabitModal() { document.getElementById('habitModal').style.display = 'none'; }
        function renderHabitManager() {
            const list = document.getElementById('modalHabitList'); list.innerHTML = '';
            habitList.forEach((h, i) => {
                const item = document.createElement('div'); item.className = "flex items-center justify-between bg-gray-50 p-4 rounded-2xl";
                item.innerHTML = `<div><span class="font-bold text-gray-800">${h.name}</span><button onclick="getHabitTip('${h.name}')" class="ml-2 text-[10px] text-blue-500 font-black">✨ ИИ</button></div>
                <button onclick="habitList.splice(${i}, 1); renderHabitManager(); renderHabits();" class="text-red-500">×</button>`;
                list.appendChild(item);
            });
            localStorage.setItem('study_tracker_v5_habits', JSON.stringify(habitList));
        }
        function addNewHabit() {
            const val = document.getElementById('newHabitInput').value;
            if (val) { habitList.push({id: 'h'+Date.now(), name: val}); document.getElementById('newHabitInput').value = ''; renderHabitManager(); renderHabits(); }
        }
        window.onload = init;
    </script>
</body>
</html>
