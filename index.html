<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–£—á–µ–±–Ω—ã–π –ü–ª–∞–Ω 2026</title>
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–ü–ª–∞–Ω 2026">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --ios-bg: #000000;
            --ios-card: #1c1c1e;
            --ios-accent: #0a84ff;
            --ios-success: #32d74b;
            --ios-error: #ff453a;
        }
        body {
            background-color: var(--ios-bg);
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .card { background-color: var(--ios-card); border-radius: 12px; }
        
        .week-nav {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .week-nav::-webkit-scrollbar { display: none; }
        .week-item { scroll-snap-align: start; flex: 0 0 auto; }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è */
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(10, 132, 255, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(10, 132, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(10, 132, 255, 0); }
        }
        .active-session-card {
            animation: pulse-blue 2s infinite;
            border: 1px solid var(--ios-accent);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .dot-blink { animation: blink 1.5s infinite; }
    </style>
</head>
<body class="safe-area-top safe-area-bottom min-h-screen flex flex-col">

    <!-- Header -->
    <header class="p-4 sticky top-0 bg-black/80 backdrop-blur-md z-20 border-b border-white/10">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold">–í–µ—Å–Ω–∞ 2026</h1>
                <div id="active-status-header" class="hidden items-center text-blue-400 text-xs font-bold mt-1">
                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2 dot-blink"></span>
                    –°–ï–ô–ß–ê–° –ò–î–ï–¢ –ó–ê–ù–Ø–¢–ò–ï
                </div>
                <p id="current-date-display" class="text-gray-400 text-sm mt-1">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <div class="text-right">
                <span class="text-xs uppercase text-gray-500 font-semibold">–î–æ–ª–≥ (—á–∞—Å—ã)</span>
                <div id="debt-counter" class="text-2xl font-mono text-red-500 font-bold">0</div>
            </div>
        </div>
    </header>

    <!-- Progress Bars -->
    <section class="p-4 space-y-3">
        <div id="stats-container" class="space-y-4"></div>
    </section>

    <!-- Week Navigation -->
    <nav class="week-nav px-4 py-2 border-b border-white/5 space-x-2" id="week-selector"></nav>

    <!-- Main Content -->
    <main class="flex-1 p-4 overflow-y-auto" id="days-container"></main>

    <!-- Footer with SOS -->
    <footer class="p-6 border-t border-white/10 bg-black/50">
        <button id="sos-btn" class="w-full bg-red-600/20 text-red-500 border border-red-600/30 py-4 rounded-2xl font-black text-sm active:scale-95 transition-all">
            üö® SOS: –ü–ï–†–ï–°–ß–ò–¢–ê–¢–¨ –ì–†–ê–§–ò–ö
        </button>
        <p class="text-[10px] text-gray-600 text-center mt-4 uppercase tracking-widest italic">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è iPhone PWA</p>
    </footer>

    <script>
        const CONFIG = {
            preStart: new Date(2026, 1, 28), // 28 —Ñ–µ–≤—Ä–∞–ª—è 2026
            startDate: new Date(2026, 2, 1),  // 1 –º–∞—Ä—Ç–∞ 2026
            endDate: new Date(2026, 3, 30),
            targets: { "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞": 180, "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞": 50, "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫": 80 },
            subjectsOrder: ["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫"],
            schedule: {
                weekday: { start: "18:30", end: "21:30" },
                weekend: { start: "08:00", end: "19:00" }
            }
        };

        let state = {
            completedDays: JSON.parse(localStorage.getItem('study_plan_v2_completed')) || {},
            pauses: JSON.parse(localStorage.getItem('study_plan_v2_pauses')) || {}, 
            sosRedistribution: JSON.parse(localStorage.getItem('study_plan_v2_sos')) || 0,
            currentWeekIndex: 0,
            today: new Date(), 
            notified: new Set() 
        };

        function generatePlan() {
            const plan = [];
            let current = new Date(CONFIG.preStart);
            let subjectIndex = 0; 
            let weekCounter = 0;

            while (current <= CONFIG.endDate) {
                const dateKey = current.toISOString().split('T')[0];
                const dayOfWeek = current.getDay();
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                
                let baseHours = 0;
                let timeRange = { start: "-", end: "-" };
                let subject = "";

                if (current.toDateString() === CONFIG.preStart.toDateString()) {
                    subject = "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å—Ç–∞—Ä—Ç—É";
                    baseHours = 0;
                } else {
                    baseHours = isWeekend ? 11 : 3;
                    const sched = isWeekend ? CONFIG.schedule.weekend : CONFIG.schedule.weekday;
                    timeRange = sched;

                    const diffDays = Math.round((current - CONFIG.startDate) / (1000 * 60 * 60 * 24));
                    if (diffDays < 4) {
                        subject = "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫";
                    } else {
                        subject = CONFIG.subjectsOrder[subjectIndex % 3];
                        subjectIndex++;
                    }
                }

                if (dayOfWeek === 1 && plan.length > 0) weekCounter++;

                plan.push({
                    date: new Date(current),
                    dateKey: dateKey,
                    dayName: current.toLocaleDateString('ru-RU', { weekday: 'long' }),
                    dayMonth: current.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }),
                    subject: subject,
                    hours: baseHours,
                    startTime: timeRange.start,
                    endTime: timeRange.end,
                    weekIdx: weekCounter,
                    isWeekend: isWeekend
                });
                current.setDate(current.getDate() + 1);
            }
            return plan;
        }

        const fullPlan = generatePlan();

        function calculateStats() {
            const stats = { "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞": 0, "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞": 0, "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫": 0, "debt": 0 };
            const compareToday = new Date(state.today);
            compareToday.setHours(0,0,0,0);

            fullPlan.forEach(day => {
                const isDone = state.completedDays[day.dateKey];
                if (isDone) {
                    if (stats[day.subject] !== undefined) {
                        stats[day.subject] += day.hours + state.sosRedistribution;
                    }
                } else {
                    // –î–æ–ª–≥ —Ç–æ–ª—å–∫–æ —Å 1 –º–∞—Ä—Ç–∞ (—Å—Ç—Ä–æ–≥–æ >= CONFIG.startDate)
                    if (compareToday >= CONFIG.startDate && day.date < compareToday && day.hours > 0) {
                        stats.debt += day.hours + state.sosRedistribution;
                    }
                }
            });
            return stats;
        }

        function renderStats() {
            const stats = calculateStats();
            const container = document.getElementById('stats-container');
            container.innerHTML = '';

            Object.keys(CONFIG.targets).forEach(sub => {
                const done = Math.floor(stats[sub]);
                const target = CONFIG.targets[sub];
                const percent = Math.min(100, Math.round((done / target) * 100));
                
                container.innerHTML += `
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span>${sub} ${state.sosRedistribution > 0 ? '<span class="text-red-400 text-[10px]">+SOS</span>' : ''}</span>
                            <span class="text-gray-400">${percent}% (${done}/${target} —á)</span>
                        </div>
                        <div class="w-full bg-white/10 h-1.5 rounded-full overflow-hidden">
                            <div class="bg-blue-500 h-full transition-all duration-500" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('debt-counter').textContent = Math.floor(stats.debt);
        }

        function handleManualPause(dateKey) {
            const minutes = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è:", "15");
            if (minutes !== null && !isNaN(minutes) && minutes.trim() !== "") {
                const currentPause = state.pauses[dateKey] || 0;
                state.pauses[dateKey] = currentPause + parseInt(minutes); 
                localStorage.setItem('study_plan_v2_pauses', JSON.stringify(state.pauses));
                renderDays();
            }
        }

        function renderDays() {
            const container = document.getElementById('days-container');
            container.innerHTML = '';
            const weekDays = fullPlan.filter(d => d.weekIdx === state.currentWeekIndex);
            
            const nowTimeInMinutes = state.today.getHours() * 60 + state.today.getMinutes();

            let sessionInProgress = false;

            weekDays.forEach(day => {
                const isDone = state.completedDays[day.dateKey];
                
                // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞—Ç —á–µ—Ä–µ–∑ toDateString
                const isToday = (state.today.toDateString() === day.date.toDateString());
                
                let isNow = false;
                if (isToday && day.hours > 0 && !isDone) {
                    const [hStart, mStart] = day.startTime.split(':').map(Number);
                    const [hEnd, mEnd] = day.endTime.split(':').map(Number);
                    const startTotal = hStart * 60 + mStart;
                    const endTotal = hEnd * 60 + mEnd + (state.pauses[day.dateKey] || 0);
                    
                    isNow = nowTimeInMinutes >= startTotal && nowTimeInMinutes <= endTotal;
                }
                
                if (isNow) sessionInProgress = true;

                const card = document.createElement('div');
                card.className = `card p-4 mb-4 transition-all ${isDone ? 'opacity-40 grayscale-[0.5]' : ''} ${isToday ? 'ring-2 ring-blue-500 shadow-[0_0_15px_rgba(10,132,255,0.2)]' : ''} ${isNow ? 'active-session-card' : ''}`;
                
                const pauseTime = state.pauses[day.dateKey] || 0;
                let timeDisplay = `${day.startTime} ‚Äì ${day.endTime}`;
                if (day.hours === 0) {
                    timeDisplay = "–í—ã—Ö–æ–¥–Ω–æ–π / –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞";
                } else if (pauseTime > 0) {
                    const [hEnd, mEnd] = day.endTime.split(':').map(Number);
                    const adjDate = new Date(2000, 0, 1, hEnd, mEnd + pauseTime);
                    const adjEnd = adjDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
                    timeDisplay = `${day.startTime} ‚Äì <span class="text-orange-400">${adjEnd}</span>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-[10px] uppercase tracking-wider font-black ${isDone ? 'text-green-500' : 'text-blue-400'}">
                                ${day.subject} ${isNow ? '‚Ä¢ –í –≠–§–ò–†–ï' : ''}
                            </span>
                            <h3 class="text-lg font-bold capitalize">${day.dayMonth}, ${day.dayName}</h3>
                        </div>
                        <div class="text-right">
                            <span class="block text-sm font-mono font-medium">${timeDisplay}</span>
                            <span class="text-[10px] text-gray-500 uppercase tracking-tighter">${day.hours > 0 ? (day.hours + (state.sosRedistribution > 0 ? 1 : 0)) + ' —á.' : '0 —á.'}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleDay('${day.dateKey}')" class="flex-1 py-3 rounded-xl font-bold text-sm transition-all ${isDone ? 'bg-green-600/20 text-green-500 border border-green-600/30' : 'bg-white/10 active:scale-95 text-white'}">
                            ${isDone ? '–í–´–ü–û–õ–ù–ï–ù–û ‚úì' : (day.hours === 0 ? '–ü–†–û–ß–ò–¢–ê–ù–û' : '–ì–û–¢–û–í–û')}
                        </button>
                        ${isToday && !isDone && day.hours > 0 ? `
                            <button onclick="handleManualPause('${day.dateKey}')" class="px-4 bg-orange-500/10 text-orange-500 border border-orange-500/20 rounded-xl font-bold text-xs active:scale-95">
                                –ü–ê–£–ó–ê ${pauseTime > 0 ? `+${pauseTime}–º` : ''}
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(card);
            });

            const headerStatus = document.getElementById('active-status-header');
            if (sessionInProgress) headerStatus.classList.remove('hidden');
            else headerStatus.classList.add('hidden');
        }

        async function requestNotifications() {
            if ("Notification" in window) {
                const permission = await Notification.requestPermission();
                if (permission === "granted") console.log("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã");
            }
        }

        function checkNotifications() {
            const todayStr = state.today.toISOString().split('T')[0];
            const day = fullPlan.find(d => d.dateKey === todayStr);
            if (!day || day.hours === 0 || state.completedDays[day.dateKey]) return;

            const [hStart, mStart] = day.startTime.split(':').map(Number);
            const nowTime = state.today.getHours() * 60 + state.today.getMinutes();
            const startTotal = hStart * 60 + mStart;

            if (nowTime === startTotal - 10 && !state.notified.has(todayStr + '_pre')) {
                sendNotify(`–ß–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç –Ω–∞—á–∞–ª–æ! –ü—Ä–µ–¥–º–µ—Ç: ${day.subject}. –£–¥–∞—á–∏!`);
                state.notified.add(todayStr + '_pre');
            }

            if (nowTime === startTotal + 15 && !state.notified.has(todayStr + '_late')) {
                sendNotify(`–¢—ã –æ–ø–∞–∑–¥—ã–≤–∞–µ—à—å! –ó–∞–Ω—è—Ç–∏–µ —É–∂–µ –∏–¥–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—á–Ω—É—é –ø–∞—É–∑—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.`);
                state.notified.add(todayStr + '_late');
            }
        }

        function sendNotify(text) {
            if (Notification.permission === "granted") {
                new Notification("–ü–ª–∞–Ω 2026", { body: text });
            }
        }

        document.getElementById('sos-btn').onclick = () => {
            const stats = calculateStats();
            if (stats.debt <= 0) return;

            const today = new Date(state.today);
            today.setHours(0,0,0,0);
            const remainingDays = fullPlan.filter(d => d.date >= today && !state.completedDays[d.dateKey] && d.hours > 0).length;

            if (remainingDays > 0) {
                const additionalPerDay = stats.debt / remainingDays;
                state.sosRedistribution += additionalPerDay;
                localStorage.setItem('study_plan_v2_sos', JSON.stringify(state.sosRedistribution));
                renderStats();
                renderDays();
            }
        };

        function renderWeeks() {
            const nav = document.getElementById('week-selector');
            const weeksCount = fullPlan[fullPlan.length - 1].weekIdx + 1;
            nav.innerHTML = '';
            for (let i = 0; i < weeksCount; i++) {
                const isActive = i === state.currentWeekIndex;
                const btn = document.createElement('button');
                btn.className = `week-item flex-shrink-0 py-2 px-4 text-sm font-medium rounded-full transition-all ${isActive ? 'bg-blue-600 text-white shadow-lg' : 'bg-white/5 text-gray-400'}`;
                btn.innerText = `–ù–µ–¥ ${i + 1}`;
                btn.onclick = () => { state.currentWeekIndex = i; renderWeeks(); renderDays(); };
                nav.appendChild(btn);
            }
        }

        function toggleDay(dateKey) {
            if (state.completedDays[dateKey]) delete state.completedDays[dateKey];
            else state.completedDays[dateKey] = true;
            localStorage.setItem('study_plan_v2_completed', JSON.stringify(state.completedDays));
            renderStats();
            renderDays();
        }

        function init() {
            const foundDay = fullPlan.find(d => state.today.toDateString() === d.date.toDateString());
            
            if (foundDay) {
                state.currentWeekIndex = foundDay.weekIdx;
            } else {
                state.currentWeekIndex = 0; 
            }
            
            renderStats();
            renderWeeks();
            renderDays();
            
            const monthName = state.today.toLocaleString('ru-RU', { month: 'long' });
            if (state.today >= CONFIG.preStart && state.today <= CONFIG.endDate) {
                document.getElementById('current-date-display').innerText = `–°–µ–≥–æ–¥–Ω—è: ${state.today.getDate()} ${monthName} 2026`;
            } else {
                const diff = Math.ceil((CONFIG.startDate - state.today) / (1000 * 60 * 60 * 24));
                document.getElementById('current-date-display').innerText = diff > 0 ? `–î–æ —Å—Ç–∞—Ä—Ç–∞ –∫—É—Ä—Å–∞: ${diff} –¥–Ω.` : `–ö—É—Ä—Å –∑–∞–≤–µ—Ä—à–µ–Ω`;
            }

            window.addEventListener('click', requestNotifications, { once: true });

            setInterval(() => {
                state.today = new Date();
                checkNotifications();
                renderDays();
                renderStats();
            }, 30000);
        }

        init();
    </script>
</body>
</html>
