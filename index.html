<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Учебный План 2026</title>
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="План 2026">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --ios-bg: #000000;
            --ios-card: #1c1c1e;
            --ios-accent: #0a84ff;
            --ios-success: #32d74b;
            --ios-error: #ff453a;
        }
        body {
            background-color: var(--ios-bg);
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .card { background-color: var(--ios-card); border-radius: 12px; }
        .tab-active { color: var(--ios-accent); border-bottom: 2px solid var(--ios-accent); }
        
        /* Стили для скролла недель */
        .week-nav {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .week-nav::-webkit-scrollbar { display: none; }
        .week-item { scroll-snap-align: center; flex: 0 0 100px; }
    </style>
</head>
<body class="safe-area-top safe-area-bottom min-h-screen flex flex-col">

    <!-- Header -->
    <header class="p-4 sticky top-0 bg-black/80 backdrop-blur-md z-10 border-b border-white/10">
        <div class="flex justify-between items-end">
            <div>
                <h1 class="text-2xl font-bold">Весна 2026</h1>
                <p id="current-date-display" class="text-gray-400 text-sm">Март - Апрель</p>
            </div>
            <div class="text-right">
                <span class="text-xs uppercase text-gray-500 font-semibold">Долг (часы)</span>
                <div id="debt-counter" class="text-2xl font-mono text-red-500 font-bold">0</div>
            </div>
        </div>
    </header>

    <!-- Progress Bars -->
    <section class="p-4 space-y-3">
        <div id="stats-container" class="space-y-4">
            <!-- Stats JS injected here -->
        </div>
    </section>

    <!-- Week Navigation -->
    <nav class="week-nav px-4 py-2 border-b border-white/5 space-x-2" id="week-selector">
        <!-- Weeks JS injected here -->
    </nav>

    <!-- Main Content -->
    <main class="flex-1 p-4 overflow-y-auto" id="days-container">
        <!-- Cards JS injected here -->
    </main>

    <script>
        // Конфигурация
        const CONFIG = {
            startDate: new Date(2026, 2, 1), // 1 марта 2026 (0-based month)
            endDate: new Date(2026, 3, 30),  // 30 апреля 2026
            totalDays: 61, // С 1 марта по 30 апреля включительно
            targets: {
                "Математика": 180,
                "Информатика": 50,
                "Русский язык": 80
            },
            subjectsOrder: ["Математика", "Информатика", "Русский язык"]
        };

        // Состояние приложения
        let state = {
            completedDays: JSON.parse(localStorage.getItem('study_plan_v1_completed')) || {},
            currentWeekIndex: 0,
            simulatedToday: new Date() // Для тестов можно менять. Реально: new Date()
        };

        // В 2026 году 1 марта - это Воскресенье (0)
        // Но JS getDay() возвращает 0 для воскресенья, 1 для понедельника.
        
        function generatePlan() {
            const plan = [];
            let current = new Date(CONFIG.startDate);
            let subjectIndex = 0; // Для чередования после 4 марта

            for (let i = 0; i < 61; i++) {
                const dateKey = current.toISOString().split('T')[0];
                const dayOfWeek = current.getDay();
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                
                // Расчет часов
                const hours = isWeekend ? 11 : 3;
                const timeRange = isWeekend ? "08:00 – 19:00" : "18:30 – 21:30";

                // Логика предмета
                let subject = "";
                if (i < 4) {
                    subject = "Русский язык"; // С 1 по 4 марта только Русский
                } else {
                    // С 5 марта циклическое чередование
                    subject = CONFIG.subjectsOrder[subjectIndex % 3];
                    subjectIndex++;
                }

                plan.push({
                    id: i,
                    date: new Date(current),
                    dateKey: dateKey,
                    dayName: current.toLocaleDateString('ru-RU', { weekday: 'long' }),
                    dayMonth: current.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }),
                    subject: subject,
                    hours: hours,
                    timeRange: timeRange,
                    weekNum: Math.floor((i + 1) / 7) // Простая группировка по 7 дней
                });

                current.setDate(current.getDate() + 1);
            }
            return plan;
        }

        const fullPlan = generatePlan();

        function calculateStats() {
            const stats = {
                "Математика": 0,
                "Информатика": 0,
                "Русский язык": 0,
                "debt": 0
            };

            const today = new Date();
            // Сбрасываем время для сравнения только дат
            today.setHours(0,0,0,0);

            fullPlan.forEach(day => {
                const isDone = state.completedDays[day.dateKey];
                if (isDone) {
                    stats[day.subject] += day.hours;
                } else {
                    // Если день в прошлом и не выполнен -> в долг
                    if (day.date < today) {
                        stats.debt += day.hours;
                    }
                }
            });

            return stats;
        }

        function renderStats() {
            const stats = calculateStats();
            const container = document.getElementById('stats-container');
            container.innerHTML = '';

            Object.keys(CONFIG.targets).forEach(sub => {
                const done = stats[sub];
                const target = CONFIG.targets[sub];
                const percent = Math.round((done / target) * 100);
                
                container.innerHTML += `
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span>${sub}</span>
                            <span class="text-gray-400">${percent}% (${done}/${target} ч)</span>
                        </div>
                        <div class="w-full bg-white/10 h-1.5 rounded-full overflow-hidden">
                            <div class="bg-blue-500 h-full transition-all duration-500" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('debt-counter').textContent = stats.debt;
        }

        function renderWeeks() {
            const nav = document.getElementById('week-selector');
            const totalWeeks = Math.ceil(fullPlan.length / 7);
            nav.innerHTML = '';

            for (let i = 0; i < totalWeeks; i++) {
                const isActive = i === state.currentWeekIndex;
                const btn = document.createElement('button');
                btn.className = `week-item flex-shrink-0 py-2 px-3 text-sm font-medium rounded-lg ${isActive ? 'bg-blue-600 text-white' : 'bg-white/5 text-gray-400'}`;
                btn.innerText = `Неделя ${i + 1}`;
                btn.onclick = () => {
                    state.currentWeekIndex = i;
                    renderWeeks();
                    renderDays();
                };
                nav.appendChild(btn);
            }
        }

        function toggleDay(dateKey) {
            if (state.completedDays[dateKey]) {
                delete state.completedDays[dateKey];
            } else {
                state.completedDays[dateKey] = true;
            }
            localStorage.setItem('study_plan_v1_completed', JSON.stringify(state.completedDays));
            renderStats();
            renderDays();
        }

        function renderDays() {
            const container = document.getElementById('days-container');
            container.innerHTML = '';

            const startIdx = state.currentWeekIndex * 7;
            const weekDays = fullPlan.slice(startIdx, startIdx + 7);

            weekDays.forEach(day => {
                const isDone = state.completedDays[day.dateKey];
                const isToday = new Date().toISOString().split('T')[0] === day.dateKey;
                const isPast = new Date() > day.date && !isDone;

                const card = document.createElement('div');
                card.className = `card p-4 mb-4 transition-all ${isDone ? 'opacity-50 grayscale' : ''} ${isToday ? 'ring-2 ring-blue-500' : ''}`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs uppercase font-bold ${isDone ? 'text-green-500' : 'text-blue-400'}">${day.subject}</span>
                            <h3 class="text-lg font-bold">${day.dayMonth}, ${day.dayName}</h3>
                        </div>
                        <div class="text-right">
                            <span class="block text-sm font-mono">${day.timeRange}</span>
                            <span class="text-xs text-gray-400">${day.hours} ч.</span>
                        </div>
                    </div>
                    <button 
                        onclick="toggleDay('${day.dateKey}')"
                        class="w-full py-3 rounded-xl font-bold text-sm transition-colors ${isDone ? 'bg-green-600' : 'bg-white/10 active:bg-white/20'}"
                    >
                        ${isDone ? '✓ ВЫПОЛНЕНО' : 'ОТМЕТИТЬ ВЫПОЛНЕННЫМ'}
                    </button>
                `;
                container.appendChild(card);
            });
        }

        // Авто-определение текущей недели
        function init() {
            const today = new Date().toISOString().split('T')[0];
            const foundIdx = fullPlan.findIndex(d => d.dateKey === today);
            if (foundIdx !== -1) {
                state.currentWeekIndex = Math.floor(foundIdx / 7);
            }
            
            renderStats();
            renderWeeks();
            renderDays();
        }

        init();
    </script>
</body>
</html>
